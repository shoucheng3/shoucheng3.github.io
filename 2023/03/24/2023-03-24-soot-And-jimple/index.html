

<!DOCTYPE html>
<html lang="en" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>soot-And-jimple - ShouCheng</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  
  <meta name="description" content="参考soot API：https://soot-oss...">
  <meta name="author" content="ShouCheng">
  <link rel="icon" href="/images/icons/favicon-16x16.png" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/favicon-32x32.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon-144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1445822_r673sha78lq.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/xcode.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/solarized-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      lazyload: {
        enable: true,
        only_post: 'false',
        loading: '[object Object]'
      },
      donate: {
        enable: false,
        alipay: '',
        wechat: ''
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: false
      },
      carrier: {
        enable: true
      },
      daovoice: {
        enable: true
      },
      preview: {
        background: {
          default: '',
          api: ''
        },
        motto: {
          default: '总之岁月漫长，然而值得等待！',
          typing: true,
          api: 'https://v2.jinrishici.com/one.json',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: true,
        type: 'url',
        image: '',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'default'
      },
      notification: {
        enable: true,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      },
      search: {
        enable: true,
        path: '/search.xml'
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="ShouCheng" type="application/atom+xml">
</head>

<body class="lock-screen">
  <div class="loading"></div>
  
    


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconhome j-navbar-back-home"></i>
      
      
        <i class="iconfont iconqrcode j-navbar-qrcode"></i>
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
      
        <i class="iconfont iconsearch j-navbar-search"></i>
      
    </div>
    <div class="center">soot-And-jimple</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
      <div id="qrcode-navbar"></div>
    
  </nav>

  
  

<nav class="menu">
  <div class="menu-container">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> 首页</a>
      </li><li class="menu-item">
        <a href="/galleries/ " class="underline "> 摄影</a>
      </li><li class="menu-item">
        <a href="/archives/ " class="underline "> 归档</a>
      </li><li class="menu-item">
        <a href="/tags/ " class="underline "> 标签</a>
      </li><li class="menu-item">
        <a href="/categories/ " class="underline "> 分类</a>
      </li><li class="menu-item">
        <a href="/about/ " class="underline "> 关于</a>
      </li></ul>
    
      <div class="menu-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img   class="lazyload" data-original="/images/theme/post-image.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">soot-And-jimple</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>March 24, 2023</span>
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>57724</span>
    </div>
  </div>
</section>
    <section class="main">
      <section class="content">
        <h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>soot API：<a target="_blank" rel="noopener" href="https://soot-oss.github.io/soot/docs/4.4.1/jdoc/index.html">https://soot-oss.github.io/soot/docs/4.4.1/jdoc/index.html</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://github.com/soot-oss/soot/wiki/Tutorials">https://github.com/soot-oss/soot/wiki/Tutorials</a></p>
<p>PDF：sootsurvivorsguide.pdf</p>
<p>一篇很不错的入门文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/558087790">https://zhuanlan.zhihu.com/p/558087790</a></p>
<h3 id="Soot"><a href="#Soot" class="headerlink" title="Soot"></a>Soot</h3><h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>Scene：表示进行分析一个类时产生的完整环境（上下文）。通过它，可以设置应用程序类（提供给 Soot 进行分析的类）、主类（包含主方法的类）和访问关于过程间分析的信息（例如，指针信息和调用图）。</p>
<p>SootClass：表示加载到 Soot 中或使用 Soot 创建的类。</p>
<p>SootMethod：表示类的方法。</p>
<p>SootFiled：表示类的成员字段。</p>
<p>Body：代表一个方法体，有不同的风格，对应于不同的 IR（例如 JimpleBody）。这些数据结构是使用面向对象技术实现的，并且尽可能地设计为易于使用和通用。</p>
<p>Unit： 表示 Soot 中的语句，jimple 使用 Stmt 表示。</p>
<p>Jimple 中间表示的处理方法集合在 soot.jimple、soot.jimple.internal 中，大量优化集合在 soot.jimple.toolkits.* 中，尤其是在 soot.jimple.toolkits.scalar 和 soot.jimple.toolkits.annotation.*</p>
<p>Values：一个数据被表示为一个 Value。包括：局部变量（Local）、常量（在 Jimple 中表示为 Constant）、表达式（在 Jimple 中表示为 Expr）等等。表达式有各种不同的实现，例如 BinopExpr 和 InvokeExpr ，但一般来说可以理解为对一个或多个值执行某些操作并返回另一个值。</p>
<p>Box：在 Soot 中的引用（类似于指针），一般用于修改代码，有以下两种类型。</p>
<ul>
<li>ValueBox：指 Values，每个 unit 中都有使用和定义的 Values 的概念，这对于替换 Units 中使用的或定义的 box 非常有用，例如在执行常量折叠时</li>
<li>UnitBox：指 Units，当一个 unit 可以有多个后继时（例如分支语句），就会使用 UnitBox。</li>
</ul>
<h4 id="Soot-执行阶段"><a href="#Soot-执行阶段" class="headerlink" title="Soot 执行阶段"></a>Soot 执行阶段</h4><p>Soot 中每一个执行的部分被称为 pack，而 Soot 的执行一般分为几个 packs 的阶段。第一步是生成 Jimple 代码以供各种 packs 使用。这是通过解析类、jimple 或 java 文件并将其结果通过 Jimple Body（jb） pack 进行传递。</p>
<p>packs 的命名方案相当简单。第一个字母指定 pack 接受的 IR；s 表示 Shimple，j 表示 Jimple，b 表示 Baf，g 表示 Grimp。第二个字母指定 pack 的角色；b 表示方法主体，t 表示用户定义的转换，o 表示优化，a 表示属性生成(注解)。pack 名称末尾的 p 表示 pack。例如，jap（Jimple 注解包）包含所有程序内分析。</p>
<p>下图是 Inter-procedural analysis（程序间分析） 的执行流程，在 Soot 运行周期中包括三个额外的包：cg（调用图生成），wjtp（整个 Jimple 转换包）和 wjap（整个 Jimple 注解包）。这些包生成的信息可以通过 Scene 提供给 Soot 的其他部分使用。而之后的 jtp、jop、jap 则是给每个 body 使用的，最终的产生的 bb（Baf Body 是 Soot 基于栈的中间表示，用于创建字节码）和 tag</p>
<p><img   class="lazyload" data-original="/2023/03/24/2023-03-24-soot-And-jimple/image-20230325211418466.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ><span class="image-caption">image-20230325211418466</span></p>
<p>我们可以扩展 Soot 的 Main 类以包括我们自己的分析，将一个中间步骤注入到 Soot 中，使得 Soot 可以运行我们自定义的分析并处理传递给它的所有其他选项。过程间（inter-procedural analysis）需要注入到 wjtp 阶段而过程内（intra-procedural analysis）则注入到 jtp 阶段。下图的代码示例展示了如何将一个类 MyAnalysisTagger（执行某些 intra-procedural analysis）的实例注入到 Soot 中。</p>
<p><img   class="lazyload" data-original="/2023/03/24/2023-03-24-soot-And-jimple/image-20230325221540502.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ><span class="image-caption">image-20230325221540502</span></p>
<h4 id="使用Soot创建一个类"><a href="#使用Soot创建一个类" class="headerlink" title="使用Soot创建一个类"></a>使用Soot创建一个类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//加载java.lang.Object类并创建相应的SootClass对象及SootMethods、字段SootFields</span><br><span class="hljs-comment">//如果有使用其他的类文件，需要引入例如标准库的类Scene.v().loadClassAndSupport(&quot;java.lang.System&quot;);</span><br>Scene.v().loadClassAndSupport(<span class="hljs-string">&quot;MyClass&quot;</span>);<br><br><span class="hljs-comment">//为HelloWorld类创建SootClass对象。</span><br>sClass = <span class="hljs-keyword">new</span> SootClass(<span class="hljs-string">&quot;HelloWorld&quot;</span>, Modifier.PUBLIC);<br><br><span class="hljs-comment">//设置父类为java.lang.Object的SootClass对象</span><br>sClass.setSuperclass(Scene.v().getSootClass(<span class="hljs-string">&quot;java.lang.Object&quot;</span>));<br><br><span class="hljs-comment">//把新建的SootClass添加到Scene</span><br>Scene.v().addClass(sClass);<br><br><span class="hljs-comment">//创建一个main方法</span><br>method = <span class="hljs-keyword">new</span> SootMethod(<span class="hljs-string">&quot;main&quot;</span>,                 <br>    Arrays.asList(<span class="hljs-keyword">new</span> Type[] &#123;ArrayType.v(RefType.v(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-number">1</span>)&#125;),<br>    VoidType.v(), Modifier.PUBLIC | Modifier.STATIC);<br><br><span class="hljs-comment">//将method添加到SootClass中</span><br>sClass.addMethod(method);<br><br><span class="hljs-comment">//为main方法创建一个JimpleBody，并将其设为活跃</span><br>JimpleBody body = Jimple.v().newBody(method);<br>method.setActiveBody(body);<br><br><span class="hljs-comment">//创建locals，并将其放入JimpleBody</span><br>arg = Jimple.v().newLocal(<span class="hljs-string">&quot;l0&quot;</span>, ArrayType.v(RefType.v(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-number">1</span>));<br>body.getLocals().add(arg);<br><br><span class="hljs-comment">//将第一个参数的值分配给arg</span><br>units.add(Jimple.v().newIdentityStmt(arg, <br>      Jimple.v().newParameterRef(ArrayType.v<br>        (RefType.v(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-number">1</span>), <span class="hljs-number">0</span>)));<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// insert &quot;tmpRef.println(&quot;Hello world!&quot;)&quot;</span><br>&#123;<br>    SootMethod toCall = Scene.v().getMethod<br>      (<span class="hljs-string">&quot;&lt;java.io.PrintStream: void println(java.lang.String)&gt;&quot;</span>);<br>    units.add(Jimple.v().newInvokeStmt<br>        (Jimple.v().newVirtualInvokeExpr<br>           (tmpRef, toCall.makeRef(), StringConstant.v(<span class="hljs-string">&quot;Hello world!&quot;</span>))));<br>&#125;<br><br><span class="hljs-comment">//输出为.class文件</span><br><span class="hljs-keyword">int</span> java_version = Options.v().java_version();<br>String fileName = SourceLocator.v().getFileNameFor(sClass, Options.output_format_class);<br>OutputStream streamOut = <span class="hljs-keyword">new</span> FileOutputStream(fileName);<br>BafASMBackend backend = <span class="hljs-keyword">new</span> BafASMBackend(sClass, java_version);<br>backend.generateClassFile(streamOut);<br>streamOut.close();<br>或者使用<br>String fileName = SourceLocator.v().getFileNameFor(sClass, Options.output_format_class);<br>OutputStream streamOut = <span class="hljs-keyword">new</span> JasminOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(fileName));<br>PrintWriter writerOut = <span class="hljs-keyword">new</span> PrintWriter(<span class="hljs-keyword">new</span> OutputStreamWriter(streamOut));<br>JasminClass jasminClass = <span class="hljs-keyword">new</span> soot.jimple.JasminClass(sClass);<br>jasminClass.print(writerOut);<br>writerOut.flush();<br>streamOut.close();<br><br><span class="hljs-comment">//输出为jimple文件</span><br>String fileName = SourceLocator.v().getFileNameFor(sClass, Options.output_format_jimple);<br>OutputStream streamOut = <span class="hljs-keyword">new</span> FileOutputStream(fileName);<br>PrintWriter writerOut = <span class="hljs-keyword">new</span> PrintWriter(<span class="hljs-keyword">new</span> OutputStreamWriter(streamOut));<br>Printer.v().printTo(sClass, writerOut);<br>writerOut.flush();<br>streamOut.close();<br></code></pre></td></tr></table></figure>

<ul>
<li>SootClass 对应着一个对象。</li>
<li>SootMethod 只能有一个活动的 Body，可通过 SootMethod.getActiveBody() 获取。</li>
<li>Body有三个重要的功能：Locals、Traps 和 Units。<ul>
<li>Locals 是主体中的局部变量。</li>
<li>Traps 是哪些单元捕获的哪些异常。</li>
<li>Units 是语句本身。</li>
</ul>
</li>
</ul>
<h4 id="Soot配置与使用"><a href="#Soot配置与使用" class="headerlink" title="Soot配置与使用"></a>Soot配置与使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">G.reset();<span class="hljs-comment">//初始化soot</span><br>Options.v().set_src_prec(Options.src_prec_class);<span class="hljs-comment">//设置处理文件的类型,默认的是class文件</span><br>Options.v().set_process_dir(Collections.singletonList(processDir))<span class="hljs-comment">//处理路径</span><br>Options.v().set_whole_program(<span class="hljs-keyword">true</span>);<span class="hljs-comment">//开启全局模式</span><br>Options.v().set_allow_phantom_refs(<span class="hljs-keyword">true</span>);<span class="hljs-comment">//开启虚引用</span><br>Options.v().set_prepend_classpath(<span class="hljs-keyword">true</span>);<span class="hljs-comment">//允许soot使用JVM的classpath</span><br>Options.v().set_output_format(Options.output_format_jimple);<span class="hljs-comment">//文件输出格式设置为jimple</span><br>Scene.v().loadNecessaryClasses();<span class="hljs-comment">//加载所有需要的类</span><br>PackManager.v().runPacks();<span class="hljs-comment">//运行soot中所有的分析包</span><br>PackManager.v().writeOutput();<span class="hljs-comment">//输出结果</span><br><br>G.reset();<br>Options.v().set_src_prec(Options.src_prec_class);<br>Options.v().set_process_dir(Collections.singletonList(processDir))<br>Options.v().set_whole_program(<span class="hljs-keyword">true</span>);<br>Options.v().set_allow_phantom_refs(<span class="hljs-keyword">true</span>);<br>Options.v().set_prepend_classpath(<span class="hljs-keyword">true</span>);<br>Options.v().set_output_format(Options.output_format_jimple);<br>Scene.v().loadNecessaryClasses();<br>PackManager.v().runPacks();<br>PackManager.v().writeOutput();<br></code></pre></td></tr></table></figure>

<h5 id="apk配置"><a href="#apk配置" class="headerlink" title="apk配置"></a>apk配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">G.reset();<br>Options.v().set_prepend_classpath(<span class="hljs-keyword">true</span>);<br>Options.v().set_allow_phantom_refs(<span class="hljs-keyword">true</span>);<br>Options.v().set_src_prec(Options.src_prec_apk);<br>Options.v().set_process_dir(Collections.singletonList(apkPath));<br>Options.v().set_android_jars(androidJarPath);<br>Options.v().set_whole_program(<span class="hljs-keyword">true</span>);<br>List&lt;String&gt; excludeList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>excludeList.add(<span class="hljs-string">&quot;java.*&quot;</span>);<br>excludeList.add(<span class="hljs-string">&quot;javax.*&quot;</span>);<br>Options.v().set_exclude(excludeList);<span class="hljs-comment">//排除不需要分析的类和方法</span><br>Options.v().set_output_format(Options.output_format_jimple);<br>Scene.v().loadNecessaryClasses();<br><span class="hljs-comment">//PackManager.v().runPacks();</span><br></code></pre></td></tr></table></figure>

<p>设置全程序分析，默认情况下是不进行全程序分析的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>  PackManager.v().getPack(<span class="hljs-string">&quot;wjtp&quot;</span>).add(<br>      <span class="hljs-keyword">new</span> Transform(<span class="hljs-string">&quot;wjtp.myTransform&quot;</span>, <span class="hljs-keyword">new</span> SceneTransformer() &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">internalTransform</span><span class="hljs-params">(String phaseName,</span></span><br><span class="hljs-params"><span class="hljs-function">            Map options)</span> </span>&#123;<br>          System.err.println(Scene.v().getApplicationClasses());<br>        &#125;<br>      &#125;));<br>  soot.Main.main(args);<br>&#125; <br></code></pre></td></tr></table></figure>

<p>一般使用 jtp、jop、jap 三个 pack 针对每个 body 进行分析。</p>
<ul>
<li>jtp 默认使用，并且是空的，需要我们放入自己的 intra-procedural analyses。</li>
<li>jop 中有 Jimple 优化功能，但在默认情况下是禁用的。</li>
<li>jap 默认启用，但是其中的处理功能会被禁用，当我们把自己的分析放入到 jap 时，会自动开启。</li>
<li>想要往 jtp、jop、jap 中加入 Transform 必须要使用 BodyTransformer。</li>
</ul>
<p>下面是一份 jap 的使用示例。注册了一个新的 BodyTransformer，为每个方法中的每个语句打印出标记</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>  PackManager.v().getPack(<span class="hljs-string">&quot;jap&quot;</span>).add(<br>      <span class="hljs-keyword">new</span> Transform(<span class="hljs-string">&quot;jap.myTransform&quot;</span>, <span class="hljs-keyword">new</span> BodyTransformer() &#123;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">internalTransform</span><span class="hljs-params">(Body body, String phase, Map options)</span> </span>&#123;<br>          <span class="hljs-keyword">for</span> (Unit u : body.getUnits()) &#123;<br>            System.out.println(u.getTags());<br>          &#125;<br>        &#125;<br>      &#125;));<br>  Options.v().set_verbose(<span class="hljs-keyword">true</span>);<br>  PhaseOptions.v().setPhaseOption(<span class="hljs-string">&quot;jap.npc&quot;</span>, <span class="hljs-string">&quot;on&quot;</span>);<br>  soot.Main.main(args);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="数据流分析"><a href="#数据流分析" class="headerlink" title="数据流分析"></a>数据流分析</h4><ol>
<li>确定分析的性质。是向前还是向后的流分析？是否需要特别考虑分支？</li>
<li>确定预期的近似值。是 may(并集) 分析还是 must(交集) 分析？即确定合并的信息流在通过一个节点时，采取并集还是交集。</li>
<li>执行实际的流分析。实质上为中间表示中的每种语句编写方程——例如，应如何处理赋值语句。</li>
<li>决定入口节点（如果是向后流）和内部节点的初始状态或近似值——通常是空集或全集，具体取决于分析的保守程度。 执行数据流分析需要一些表示数据如何在程序中流动的结构，例如控制流图（cfg）。 Soot 数据流框架通过 soot.toolkits.graph.DirectedGraph 接口进行处理 cfg。</li>
</ol>
<p>Soot 提供了三种数据流分析的实现：</p>
<ul>
<li>ForwardFlowAnalysis 前向分析，从 UnitGraph 的入口语句开始进行向前传播。</li>
<li>BackwardFlowAnalysis 后向分析，从 UnitGraph 的出口节点开始向后传播。</li>
<li>ForwardBranchedFlowAnalysis 前向分支分析，实质上是一种前向分析，但是允许将不同的流集传播到不同的分支中。例如：处理 if(p != null) ，则可以将  p != nll 传播到为 true 的分支中，p == null 传播到为 false 的分支中。</li>
</ul>
<h4 id="继承类"><a href="#继承类" class="headerlink" title="继承类"></a>继承类</h4><p>实现分析，需要继承 ForwardFlowAnalysis（BackwardFlowAnalysis、ForwardBranchedFlowAnalysis ），其有两个参数：</p>
<ul>
<li>N：节点类型。通常是 Unit，但也可以对保存其他类型节点的图进行流分析。</li>
<li>A: 抽象类型。通常使用 sets 或 maps 作为抽象类型，但一般来说，可以使用任何你喜欢的东西。但要注意，抽象类型必须正确地实现 equals(…) 和 hashCode()，这样 Soot 才能确定什么时候达到了固定点。</li>
</ul>
<h5 id="构造函数——真正的实现"><a href="#构造函数——真正的实现" class="headerlink" title="构造函数——真正的实现"></a>构造函数——真正的实现</h5><p>实现一个构造函数，需要以 DirectedGraph&lt;N&gt; 作为参数（其中N是节点类型），并将其传递给父类的构造函数。在构造函数的末尾需要调用 doAnalysis() 方法以执行数据流分析，在调用父类构造函数和 doAnalysis() 方法之间可以自定义数据分析结构。</p>
<p>一些需要用到的方法和类：</p>
<ul>
<li>newInitialFlow() 返回一个自定义的抽象类型 A 的对象。这个对象被分配为每个语句的初始入集和出集，除了第一个语句的入集（如果实现的是一个向后分析，则为一个退出语句，例如 return 或 throw）</li>
<li>entryInitialFlow() 初始化第一个语句的入集。</li>
<li>copy(A source, A dest) 方法接受两个自定义的抽象类型 A 的参数：源和目标。实现将源复制到目标中。</li>
<li>merge(A in1, A in2, A out) 方法用于在控制流的合并点（例如 if/then/else 语句的末尾）合并流集。接受三个参数，一个来自左分支的出集，一个来自右分支的出集，这将成为合并点之后下一个语句的新合并入集。即将两个 in 集合并为一个 out 集。</li>
<li>flowThrough(A in, N d, A out) 方法接受三个参数，类型为 A 的入集； 要处理的类型为 N 的节点，通常是一个 Unit；类型为 A的出集。第一个参数始终是流函数的参数（即在正向分析中它是入集，在反向分析中它是出集），第三个参数始终是流函数的结果（即在正向分析中它是出集，在反向分析中它是入集）。是数据流分析的核心处理方法。</li>
<li>FlowSet 接口中有一些集合操作的方法以及具体实现的类<ul>
<li>ArraySparseSet：使用稀疏数组实现集合，支持高效的添加、删除、查找和迭代操作。</li>
<li>ArrayPackedSet：使用紧凑数组实现集合，可以存储更多的元素，但是由于使用了位运算，因此在操作时需要进行一些额外的计算，因此操作复杂度略高于ArraySparseSet。</li>
<li>一般来说，如果需要存储的元素数量较少，可以选择ArraySparseSet；如果需要存储更多的元素，可以选择ArrayPackedSet；如果需要表示不确定的分析结果，可以选择ToppedSet。<ul>
<li>ToppedSet：是ArraySparseSet的子类，额外支持一个元素作为“top”元素，用于表示未知的分析结果。</li>
<li>a.intersection(b,c); 表示 c=a∩b</li>
<li>a.union(b,c); 表示 c=a∪b</li>
<li>c.complement(d); 返回 c 和 d 的对称差（即 c 中存在而 d 不存在的元素以及 d 中存在而 c 中不存在的元素）</li>
<li>d.add(v); 表示 d=d∪{v}</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>最后可以把分析的结果放在 tag 中。</p>
<h5 id="活跃变量分析"><a href="#活跃变量分析" class="headerlink" title="活跃变量分析"></a>活跃变量分析</h5><p>下面是一个分析 class 中的活跃变量的简单示例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> soot.*;<br><span class="hljs-keyword">import</span> soot.options.Options;<br><span class="hljs-keyword">import</span> soot.toolkits.graph.CompleteUnitGraph;<br><span class="hljs-keyword">import</span> soot.toolkits.graph.UnitGraph;<br><span class="hljs-keyword">import</span> soot.toolkits.scalar.BackwardFlowAnalysis;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LiveAnalysis</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        G.reset();<br>        Options.v().set_src_prec(Options.src_prec_class);<br>        Options.v().set_process_dir(Collections.singletonList(<span class="hljs-string">&quot;C:\\Users\\守城\\Desktop\\Step2\\Lab3&quot;</span>));<br>        Options.v().set_whole_program(<span class="hljs-keyword">true</span>);<br>        Options.v().set_allow_phantom_refs(<span class="hljs-keyword">true</span>);<br>        Options.v().set_prepend_classpath(<span class="hljs-keyword">true</span>);<br>        Options.v().set_keep_line_number(<span class="hljs-keyword">true</span>);<br>        Options.v().set_output_format(Options.output_format_jimple);<br>        Scene.v().loadNecessaryClasses();<br>        SootClass sootClass = Scene.v().getSootClass(<span class="hljs-string">&quot;lab3&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;Name：&quot;</span> + sootClass.getName());<br>        System.out.println(<span class="hljs-string">&quot;Number of methods in SootClass: &quot;</span> + sootClass.getMethods().size());<br>        <span class="hljs-keyword">for</span> (SootMethod sootMethod : sootClass.getMethods()) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Analyzing method: &quot;</span> + sootMethod.getName());<br>            CompleteUnitGraph graph = <span class="hljs-keyword">new</span> CompleteUnitGraph(sootMethod.retrieveActiveBody());<br>            MyBackwardAnalysis myBackwardAnalysis = <span class="hljs-keyword">new</span> MyBackwardAnalysis(graph);<br>            <span class="hljs-keyword">for</span> (Unit unit : graph) &#123;<br>                Set&lt;String&gt; flowBefore = myBackwardAnalysis.getFlowBefore(unit);<br>                Set&lt;String&gt; flowAfter = myBackwardAnalysis.getFlowAfter(unit);<br>                System.out.println(<span class="hljs-string">&quot;Before: &quot;</span> + flowAfter + <span class="hljs-string">&quot; | After: &quot;</span> + flowBefore + <span class="hljs-string">&quot; | Statement: &quot;</span> + unit);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBackwardAnalysis</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BackwardFlowAnalysis</span>&lt;<span class="hljs-title">Unit</span>, <span class="hljs-title">Set</span>&lt;<span class="hljs-title">String</span>&gt;&gt; </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyBackwardAnalysis</span><span class="hljs-params">(UnitGraph graph)</span> </span>&#123;<br>            <span class="hljs-keyword">super</span>(graph);<br>            doAnalysis();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> Set&lt;String&gt; <span class="hljs-title">newInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> Set&lt;String&gt; <span class="hljs-title">entryInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(Set&lt;String&gt; in1, Set&lt;String&gt; in2, Set&lt;String&gt; out)</span> </span>&#123;<br>            out.clear();<br>            out.addAll(in1);<br>            out.addAll(in2);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">copy</span><span class="hljs-params">(Set&lt;String&gt; source, Set&lt;String&gt; dest)</span> </span>&#123;<br>            dest.clear();<br>            dest.addAll(source);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flowThrough</span><span class="hljs-params">(Set&lt;String&gt; in, Unit unit, Set&lt;String&gt; out)</span> </span>&#123;<br>            out.clear();<br>            out.addAll(in);<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes()) &#123;<br>                Value value = box.getValue();<br>                <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Local) &#123;<br>                    out.remove(((Local) value).getName());<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getUseBoxes())&#123;<br>                Value value = box.getValue();<br>                <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Local)&#123;<br>                    out.add(((Local) value).getName());<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="常量传播"><a href="#常量传播" class="headerlink" title="常量传播"></a>常量传播</h5><p>跟活跃变量分析不同，常量传播需要设置初始集，需要把方法的参数先判断是否为常量，再将其添加初始集合。同时，在进行merge合并时，大部分时取交集或者是其他更加复杂的算法，但是不会取并集。</p>
<p>因为如果是两条支路中，在一条支路中是常量，但是在另外一条支路中不是常量，所以此时取交集会更加准确一点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstantPropagation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ForwardFlowAnalysis</span>&lt;<span class="hljs-title">Unit</span>, <span class="hljs-title">FlowSet</span>&lt;<span class="hljs-title">String</span>&gt;&gt; </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstantPropagation</span><span class="hljs-params">(UnitGraph graph)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(graph);<br>        doAnalysis();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> FlowSet&lt;String&gt; <span class="hljs-title">newInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ArraySparseSet&lt;&gt;();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> FlowSet&lt;String&gt; <span class="hljs-title">entryInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>        FlowSet&lt;String&gt; flowSet = <span class="hljs-keyword">new</span> ArraySparseSet&lt;&gt;();<br>        List&lt;Value&gt; valueList = ((UnitGraph)graph).getBody().getParameterRefs();<br>        <span class="hljs-keyword">for</span> (Value value : valueList)&#123;<br>            String className = ((RefType) value.getType()).getClassName();<br>            <span class="hljs-keyword">if</span> (className.equals(<span class="hljs-string">&quot;java.lang.Integer&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.String&quot;</span>)<br>            || className.equals(<span class="hljs-string">&quot;java.lang.Boolean&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Byte&quot;</span>)<br>            || className.equals(<span class="hljs-string">&quot;java.lang.Character&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Double&quot;</span>)<br>            || className.equals(<span class="hljs-string">&quot;java.lang.Float&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Long&quot;</span>)<br>            || className.equals(<span class="hljs-string">&quot;java.lang.Short&quot;</span>))&#123;<br>                flowSet.add(value.toString());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> flowSet;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(FlowSet&lt;String&gt; in1, FlowSet&lt;String&gt; in2, FlowSet&lt;String&gt; out)</span> </span>&#123;<br>        in1.intersection(in2, out);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">copy</span><span class="hljs-params">(FlowSet&lt;String&gt; source, FlowSet&lt;String&gt; dest)</span> </span>&#123;<br>        dest.clear();<br>        dest.union(source);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flowThrough</span><span class="hljs-params">(FlowSet&lt;String&gt; in, Unit unit, FlowSet&lt;String&gt; out)</span> </span>&#123;<br>        out.clear();<br>        out.union(in);<br>        <span class="hljs-keyword">boolean</span> isConstant = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">for</span> (ValueBox box : unit.getUseBoxes())&#123;<br>            Value value = box.getValue();<br>            <span class="hljs-comment">// 判断 x = y - y 这种特殊情况</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> SubExpr &amp;&amp; ((JSubExpr) unit).getOp1Box().getValue() == ((JSubExpr) unit).getOp2Box().getValue())&#123;<br>                isConstant = <span class="hljs-keyword">true</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Constant || out.contains(value.toString()))&#123;<br>                isConstant = <span class="hljs-keyword">true</span>;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!out.contains(value.toString()))&#123;<br>                isConstant = <span class="hljs-keyword">false</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (isConstant)&#123;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                Value value = box.getValue();<br>                out.add(value.toString());<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                Value value = box.getValue();<br>                out.remove(value.toString());<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>更改之后的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstantPropagation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ForwardFlowAnalysis</span>&lt;<span class="hljs-title">Unit</span>, <span class="hljs-title">Map</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Object</span>&gt;&gt; </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstantPropagation</span><span class="hljs-params">(UnitGraph graph)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(graph);<br>        doAnalysis();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; <span class="hljs-title">newInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; <span class="hljs-title">entryInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        List&lt;Value&gt; valueList = ((UnitGraph)graph).getBody().getParameterRefs();<br>        <span class="hljs-keyword">for</span> (Value value : valueList)&#123;<br>            String className = ((RefType) value.getType()).getClassName();<br>            <span class="hljs-keyword">if</span> (className.equals(<span class="hljs-string">&quot;java.lang.Integer&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.String&quot;</span>)<br>                    || className.equals(<span class="hljs-string">&quot;java.lang.Boolean&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Byte&quot;</span>)<br>                    || className.equals(<span class="hljs-string">&quot;java.lang.Character&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Double&quot;</span>)<br>                    || className.equals(<span class="hljs-string">&quot;java.lang.Float&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Long&quot;</span>)<br>                    || className.equals(<span class="hljs-string">&quot;java.lang.Short&quot;</span>))&#123;<br>                map.put(value.toString(), value.toString().substring(<span class="hljs-number">0</span>, <span class="hljs-number">11</span>));<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(Map&lt;String, Object&gt; in1, Map&lt;String, Object&gt; in2, Map&lt;String, Object&gt; out)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry1 : in1.entrySet())&#123;<br>            String parameter1 = entry1.getKey();<br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry2 : in2.entrySet())&#123;<br>                String parameter2 = entry2.getKey();<br>                <span class="hljs-keyword">if</span> (parameter1.equals(parameter2))&#123;<br>                    out.put(parameter1, <span class="hljs-string">&quot;Constant&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">copy</span><span class="hljs-params">(Map&lt;String, Object&gt; source, Map&lt;String, Object&gt; dest)</span> </span>&#123;<br>        dest.clear();<br>        dest.putAll(source);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flowThrough</span><span class="hljs-params">(Map&lt;String, Object&gt; in, Unit unit, Map&lt;String, Object&gt; out)</span> </span>&#123;<br>        out.clear();<br>        out.putAll(in);<br>        <span class="hljs-keyword">boolean</span> isConstant = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">boolean</span> isConstantValue = <span class="hljs-keyword">true</span>;<br>        <span class="hljs-keyword">boolean</span> isParameter = <span class="hljs-keyword">false</span>;<br>        String para = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">for</span> (ValueBox box : unit.getUseBoxes())&#123;<br>            Value value = box.getValue();<br>            <span class="hljs-comment">// 判断 x = y - y 这种特殊情况</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> SubExpr &amp;&amp; ((JSubExpr) unit).getOp1Box().getValue() == ((JSubExpr) unit).getOp2Box().getValue())&#123;<br>                isConstant = <span class="hljs-keyword">true</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (out.containsKey(value.toString()) &amp;&amp; ((String)out.get(value.toString())).equals(<span class="hljs-string">&quot;NAC&quot;</span>))&#123;<br>                isConstant = <span class="hljs-keyword">false</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Constant || (out.containsKey(value.toString()) &amp;&amp; ((String)out.get(value.toString())).startsWith(<span class="hljs-string">&quot;@parameter&quot;</span>)))&#123;<br>                isConstant = <span class="hljs-keyword">true</span>;<br>                <span class="hljs-keyword">if</span> (out.containsKey(value.toString()) &amp;&amp; ((String)out.get(value.toString())).equals(<span class="hljs-string">&quot;Constant&quot;</span>)) isConstantValue = <span class="hljs-keyword">false</span>;<br>                <span class="hljs-keyword">if</span> (out.containsKey(value.toString()) &amp;&amp; ((String)out.get(value.toString())).startsWith(<span class="hljs-string">&quot;@parameter&quot;</span>))&#123;<br>                    isParameter = <span class="hljs-keyword">true</span>;<br>                    para = ((String)out.get(value.toString())).substring(<span class="hljs-number">0</span>, <span class="hljs-number">11</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (isConstant &amp;&amp; isConstantValue &amp;&amp; !isParameter)&#123;<br>            <span class="hljs-keyword">int</span> constantValue = <span class="hljs-number">0</span>;<br>            <span class="hljs-comment">// 单个赋值语句</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> JAssignStmt)&#123;<br>                Value op = ((JAssignStmt)unit).getRightOp();<br>                <span class="hljs-keyword">if</span> (out.containsKey(op.toString()))&#123;<br>                    constantValue = (Integer)(out.get(op.toString()));<br>                &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op <span class="hljs-keyword">instanceof</span> Constant)&#123;<br>                    constantValue = ((IntConstant)op).value;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 判断加法</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> AddExpr)&#123;<br>                Value op1 = ((AddExpr) unit).getOp1();<br>                Value op2 = ((AddExpr) unit).getOp2();<br>                constantValue = ((IntConstant)op1).value + ((IntConstant)op2).value;<br>            &#125;<br>            <span class="hljs-comment">// 判断减法</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> SubExpr)&#123;<br>                Value op1 = ((JSubExpr) unit).getOp1();<br>                Value op2 = ((JSubExpr) unit).getOp2();<br>                constantValue = ((IntConstant)op1).value - ((IntConstant)op2).value;<br>            &#125;<br>            <span class="hljs-comment">// 判断乘法</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> MulExpr)&#123;<br>                Value op1 = ((MulExpr) unit).getOp1();<br>                Value op2 = ((MulExpr) unit).getOp2();<br>                constantValue = ((IntConstant)op1).value * ((IntConstant)op2).value;<br>            &#125;<br>            <span class="hljs-comment">// 判断除法</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> DivExpr)&#123;<br>                Value op1 = ((DivExpr) unit).getOp1();<br>                Value op2 = ((DivExpr) unit).getOp2();<br>                constantValue = ((IntConstant)op1).value / ((IntConstant)op2).value;<br>            &#125;<br>            <span class="hljs-comment">// 判断取余</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> RemExpr)&#123;<br>                Value op1 = ((RemExpr) unit).getOp1();<br>                Value op2 = ((RemExpr) unit).getOp2();<br>                constantValue = ((IntConstant)op1).value % ((IntConstant)op2).value;<br>            &#125;<br>            <span class="hljs-comment">// 判断与运算</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> AndExpr)&#123;<br>                IntConstant op1 = (IntConstant) ((AndExpr) unit).getOp1();<br>                IntConstant op2 = (IntConstant) ((AndExpr) unit).getOp2();<br>                constantValue = op1.value &amp; op2.value;<br>            &#125;<br>            <span class="hljs-comment">// 判断或运算</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> OrExpr)&#123;<br>                IntConstant op1 = (IntConstant) ((OrExpr) unit).getOp1();<br>                IntConstant op2 = (IntConstant) ((OrExpr) unit).getOp2();<br>                constantValue = op1.value | op2.value;<br>            &#125;<br>            <span class="hljs-comment">// 判断异或运算</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> XorExpr)&#123;<br>                IntConstant op1 = (IntConstant) ((XorExpr) unit).getOp1();<br>                IntConstant op2 = (IntConstant) ((XorExpr) unit).getOp2();<br>                constantValue = op1.value ^ op2.value;<br>            &#125;<br>            <span class="hljs-comment">// 判断左移</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> ShlExpr)&#123;<br>                IntConstant op1 = (IntConstant) ((ShlExpr) unit).getOp1();<br>                IntConstant op2 = (IntConstant) ((ShlExpr) unit).getOp2();<br>                constantValue = op1.value &lt;&lt; op2.value;<br>            &#125;<br>            <span class="hljs-comment">// 判断右移</span><br>            <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> ShrExpr)&#123;<br>                IntConstant op1 = (IntConstant) ((ShrExpr) unit).getOp1();<br>                IntConstant op2 = (IntConstant) ((ShrExpr) unit).getOp2();<br>                constantValue = op1.value &gt;&gt; op2.value;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                Value value = box.getValue();<br>                out.put(value.toString(), constantValue);<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isConstant &amp;&amp; !isConstantValue)&#123;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                Value value = box.getValue();<br>                out.put(value.toString(), <span class="hljs-string">&quot;Constant&quot;</span>);<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isConstant &amp;&amp; isParameter)&#123;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                Value value = box.getValue();<br>                out.put(value.toString(), para);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                Value value = box.getValue();<br>                out.put(value.toString(), <span class="hljs-string">&quot;NAC&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="死代码消除"><a href="#死代码消除" class="headerlink" title="死代码消除"></a>死代码消除</h5><ul>
<li>控制流分析<ul>
<li>从方法入口开始，遍历 CFG 并标记可达语句。当遍历结束时，那些没有被标记的语句即控制流不可达。</li>
</ul>
</li>
<li>活跃变量分析<ul>
<li>无用赋值：一个局部变量在一条语句中被赋值，但再也没有被该语句后面的语句读取，这样的变量和语句分别被称为无用变量和无用赋值。</li>
<li>所以如果一个赋值语句中，等号左侧是一个无用变量，那么就可把该语句标记为无用赋值，然后去除。</li>
</ul>
</li>
<li>常量传播<ul>
<li>分支不可达：预先对被检测代码应用常量传播分析，通过它来告诉我们条件值是否为常量，然后在遍历 CFG 时，我们不进入相应的不可达分支</li>
</ul>
lab完成中的死代码消除部分，写的不咋地，将就一下。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> soot.*;<br><span class="hljs-keyword">import</span> soot.jimple.*;<br><span class="hljs-keyword">import</span> soot.jimple.infoflow.InfoflowConfiguration;<br><span class="hljs-keyword">import</span> soot.jimple.infoflow.android.InfoflowAndroidConfiguration;<br><span class="hljs-keyword">import</span> soot.jimple.infoflow.android.SetupApplication;<br><span class="hljs-keyword">import</span> soot.jimple.internal.*;<br><span class="hljs-keyword">import</span> soot.jimple.toolkits.callgraph.Edge;<br><span class="hljs-keyword">import</span> soot.options.Options;<br><span class="hljs-keyword">import</span> soot.toolkits.graph.CompleteUnitGraph;<br><span class="hljs-keyword">import</span> soot.toolkits.graph.UnitGraph;<br><span class="hljs-keyword">import</span> soot.toolkits.scalar.BackwardFlowAnalysis;<br><span class="hljs-keyword">import</span> soot.toolkits.scalar.ForwardFlowAnalysis;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadCodeEliminator</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        initializeSoot();<br>        initializeFlowDroid();<br>        <span class="hljs-comment">// 去除无需分析的androidx、R类</span><br>        Collection&lt;SootClass&gt; toAnalysisClasses = Scene.v().getApplicationClasses();<br>        toAnalysisClasses.removeIf(sootClass -&gt; sootClass.getName().startsWith(<span class="hljs-string">&quot;androidx&quot;</span>) || sootClass.getName().startsWith(<span class="hljs-string">&quot;com.example.lab_code.R&quot;</span>) || sootClass.getName().startsWith(<span class="hljs-string">&quot;com.example.lab_code.BuildConfig&quot;</span>));<br>        <span class="hljs-comment">//添加未被调用的方法</span><br>        Map&lt;SootClass, Set&lt;SootMethod&gt;&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (SootClass sootClass : toAnalysisClasses)&#123;<br>            <span class="hljs-keyword">if</span> (sootClass.getName().equals(<span class="hljs-string">&quot;dummyMainClass&quot;</span>)) <span class="hljs-keyword">continue</span>;<br>            Set&lt;SootMethod&gt; sootMethods = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br>            <span class="hljs-keyword">for</span> (SootMethod sootMethod : sootClass.getMethods())&#123;<br>                <span class="hljs-keyword">boolean</span> isCalled = <span class="hljs-keyword">false</span>;<br>                Iterator&lt;Edge&gt; iterator = Scene.v().getCallGraph().edgesInto(sootMethod);<br>                <span class="hljs-keyword">if</span> (iterator.hasNext())&#123;<br>                    isCalled = <span class="hljs-keyword">true</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!isCalled)&#123;<br>                    System.out.println(<span class="hljs-string">&quot;在类: &quot;</span> + sootClass.getName() + <span class="hljs-string">&quot; 的方法: &quot;</span> + sootMethod.getName() + <span class="hljs-string">&quot; 从未被调用&quot;</span>);<br>                    sootMethods.add(sootMethod);<br>                &#125;<br>            &#125;<br>            hashMap.put(sootClass, sootMethods);<br>        &#125;<br>        <span class="hljs-comment">//删除未被调用的方法</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;SootClass, Set&lt;SootMethod&gt;&gt; entry : hashMap.entrySet())&#123;<br>            SootClass sootClass = entry.getKey();<br>            Set&lt;SootMethod&gt; sootMethods = entry.getValue();<br>            <span class="hljs-keyword">for</span> (SootMethod sootMethod : sootMethods)&#123;<br>            Scene.v().getSootClass(sootClass.getName()).removeMethod(sootMethod);<br>            System.out.println(<span class="hljs-string">&quot;删除类: &quot;</span> + sootClass.getName() + <span class="hljs-string">&quot; 的方法: &quot;</span> + sootMethod.getName());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 活跃变量分析去除无效赋值</span><br>        <span class="hljs-keyword">for</span> (SootClass sootClass : toAnalysisClasses)&#123;<br>            <span class="hljs-keyword">if</span> (sootClass.getName().equals(<span class="hljs-string">&quot;dummyMainClass&quot;</span>)) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-keyword">for</span> (SootMethod sootMethod : sootClass.getMethods()) &#123;<br>                CompleteUnitGraph graph = <span class="hljs-keyword">new</span> CompleteUnitGraph(sootMethod.retrieveActiveBody());<br>                LiveAnalysis liveAnalysis = <span class="hljs-keyword">new</span> LiveAnalysis(graph);<br>                <span class="hljs-keyword">for</span> (Unit unit : graph) &#123;<br>                    <span class="hljs-keyword">boolean</span> toRemove = <span class="hljs-keyword">false</span>;<br>                    Set&lt;String&gt; flowAfter = liveAnalysis.getFlowAfter(unit);<br>                    <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes()) &#123;<br>                        Value value = box.getValue();<br>                        <span class="hljs-keyword">for</span> (String liveVariable : flowAfter)&#123;<br>                            <span class="hljs-keyword">if</span> (liveVariable.equals(value.toString()))&#123;<br>                                toRemove = <span class="hljs-keyword">false</span>;<br>                                <span class="hljs-keyword">break</span>;<br>                            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> InstanceFieldRef &amp;&amp; liveVariable.equals(((InstanceFieldRef) value).getBase().toString()))&#123;<br>                                toRemove = <span class="hljs-keyword">false</span>;<br>                                <span class="hljs-keyword">break</span>;<br>                            &#125;<br>                            toRemove = <span class="hljs-keyword">true</span>;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (toRemove)&#123;<br>                        System.out.println(<span class="hljs-string">&quot;在类: &quot;</span> + sootClass.getName() + <span class="hljs-string">&quot; 的方法 &quot;</span> + sootMethod.getName() + <span class="hljs-string">&quot; 中移除的语句为: &quot;</span> + unit);<br>                        Scene.v().getCallGraph().removeAllEdgesOutOf(unit);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//常量传播</span><br>        List&lt;Unit&gt; toRemoveUnits = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (SootClass sootClass : toAnalysisClasses)&#123;<br>            <span class="hljs-keyword">if</span> (sootClass.getName().equals(<span class="hljs-string">&quot;dummyMainClass&quot;</span>)) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-keyword">for</span> (SootMethod sootMethod : sootClass.getMethods()) &#123;<br>                CompleteUnitGraph graph = <span class="hljs-keyword">new</span> CompleteUnitGraph(sootMethod.retrieveActiveBody());<br>                ConstantPropagation constantPropagation = <span class="hljs-keyword">new</span> ConstantPropagation(graph);<br>                <span class="hljs-keyword">for</span> (Unit unit : graph) &#123;<br>                    Map&lt;String, Object&gt; flowBefore = constantPropagation.getFlowBefore(unit);<br>                    <span class="hljs-keyword">if</span> (unit.branches())&#123;<br>                        <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> IfStmt)&#123;<br>                            Value condition = ((IfStmt)unit).getCondition();<br>                            Unit targetUnit = ((IfStmt)unit).getTarget();<br>                            <span class="hljs-keyword">if</span> (condition <span class="hljs-keyword">instanceof</span> EqExpr)&#123;<br>                                EqExpr eqExpr = (EqExpr) condition;<br>                            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (condition <span class="hljs-keyword">instanceof</span> GeExpr)&#123;<br>                                GeExpr geExpr = (GeExpr) condition;<br>                            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (condition <span class="hljs-keyword">instanceof</span> GtExpr)&#123;<br>                                GtExpr gtExpr = (GtExpr) condition;<br>                            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (condition <span class="hljs-keyword">instanceof</span> LeExpr)&#123;<br>                                LeExpr leExpr = (LeExpr) condition;<br>                                Value op1 = leExpr.getOp1();<br>                                Value op2 = leExpr.getOp2();<br>                                <span class="hljs-keyword">if</span> (flowBefore.containsKey(op1.toString()) &amp;&amp;<br>                                ((String)flowBefore.get(op1.toString())).equals(<span class="hljs-string">&quot;NAC&quot;</span>)) <span class="hljs-keyword">continue</span>;<br>                                <span class="hljs-keyword">if</span> (flowBefore.containsKey(op1.toString()) &amp;&amp;<br>                                        ((String)flowBefore.get(op1.toString())).equals(<span class="hljs-string">&quot;Constant&quot;</span>))&#123;<br>                                    System.out.println(<span class="hljs-string">&quot;该值来自上面的分支，无法直接判断！&quot;</span>);<br>                                &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(flowBefore.containsKey(op1.toString()) &amp;&amp;<br>                                        ((String)flowBefore.get(op1.toString())).startsWith(<span class="hljs-string">&quot;@parameter&quot;</span>))&#123;<br>                                    System.out.println(<span class="hljs-string">&quot;该变量为方法参数，无法在方法内部进行判断!&quot;</span>);<br>                                    Iterator&lt;Edge&gt; iterator = Scene.v().getCallGraph().edgesInto(sootMethod);<br>                                    <span class="hljs-keyword">while</span> (iterator.hasNext())&#123;<br>                                        Edge edge = iterator.next();<br>                                        <span class="hljs-keyword">int</span> idx = (((String)flowBefore.get(op1.toString())).charAt(<span class="hljs-number">10</span>)) - <span class="hljs-number">48</span>;<br>                                        Unit callEdge = edge.srcUnit();<br>                                        InvokeExpr invokeExpr = ((InvokeStmt) callEdge).getInvokeExpr();<br>                                        Value arg = invokeExpr.getArg(idx);<br>                                        <span class="hljs-keyword">if</span> (((IntConstant)arg).value &lt;= ((IntConstant)op2).value)&#123;<br>                                            List&lt;Unit&gt; preds = graph.getPredsOf(targetUnit);<br>                                            <span class="hljs-keyword">for</span> (Unit pred : preds)&#123;<br>                                                System.out.println(pred);<br>                                            &#125;<br>                                        &#125;<br>                                    &#125;<br>                                &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flowBefore.containsKey(op1.toString()) &amp;&amp;<br>                                        flowBefore.get(op1.toString()) <span class="hljs-keyword">instanceof</span> IntConstant)&#123;<br>                                    <span class="hljs-keyword">if</span> (((IntConstant)flowBefore.get(op1.toString())).value &lt;= ((IntConstant)op2).value)&#123;<br>                                        RemoveUnit(toRemoveUnits, graph, unit);<br>                                    &#125;<span class="hljs-keyword">else</span> &#123;<br>                                        toRemoveUnits.add(targetUnit);<br>                                        RemoveUnit(toRemoveUnits, graph, targetUnit);<br>                                    &#125;<br>                                &#125;<br>                            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (condition <span class="hljs-keyword">instanceof</span> LtExpr)&#123;<br>                                LtExpr ltExpr = (LtExpr) condition;<br>                            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (condition <span class="hljs-keyword">instanceof</span> IntConstant)&#123;<br>                                <span class="hljs-keyword">if</span> (((IntConstant)(condition)).value == <span class="hljs-number">0</span>) &#123;<br>                                    toRemoveUnits.add(targetUnit);<br>                                    RemoveUnit(toRemoveUnits, graph, targetUnit);<br>                                &#125;<span class="hljs-keyword">else</span> &#123;<br>                                    RemoveUnit(toRemoveUnits, graph, unit);<br>                                &#125;<br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> SwitchStmt)&#123;<br>                            List&lt;Unit&gt; caseTargets = ((SwitchStmt) unit).getTargets();<br>                            Value key = ((SwitchStmt) unit).getKey();<br>                            <span class="hljs-keyword">if</span> (flowBefore.containsKey(key.toString()) &amp;&amp;<br>                                    ((String)flowBefore.get(key.toString())).equals(<span class="hljs-string">&quot;NAC&quot;</span>)) <span class="hljs-keyword">continue</span>;<br>                            <span class="hljs-keyword">if</span> (flowBefore.containsKey(key.toString()) &amp;&amp;<br>                                    ((String)flowBefore.get(key.toString())).equals(<span class="hljs-string">&quot;Constant&quot;</span>))&#123;<br>                                System.out.println(<span class="hljs-string">&quot;该值来自上面的分支，无法直接判断！&quot;</span>);<br>                            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(flowBefore.containsKey(key.toString()) &amp;&amp;<br>                                    ((String)flowBefore.get(key.toString())).startsWith(<span class="hljs-string">&quot;@parameter&quot;</span>))&#123;<br>                                System.out.println(<span class="hljs-string">&quot;该变量为方法参数，无法在方法内部进行判断!&quot;</span>);<br>                            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(key <span class="hljs-keyword">instanceof</span> IntConstant)&#123;<br>                                Unit notRemove = ((SwitchStmt) unit).getTarget(((IntConstant)key).value);<br>                                <span class="hljs-keyword">for</span> (Unit caseTarget : caseTargets)&#123;<br>                                    <span class="hljs-keyword">if</span> (notRemove.toString().equals(caseTarget.toString())) <span class="hljs-keyword">continue</span>;<br>                                    RemoveUnit(toRemoveUnits, graph, caseTarget);<br>                                &#125;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RemoveUnit</span><span class="hljs-params">(List&lt;Unit&gt; toRemoveUnits, CompleteUnitGraph graph, Unit targetUnit)</span> </span>&#123;<br>        Unit succ = graph.getSuccsOf(targetUnit).get(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>)&#123;<br>            toRemoveUnits.add(succ);<br>            <span class="hljs-keyword">if</span> ((succ <span class="hljs-keyword">instanceof</span> JGotoStmt) || (succ <span class="hljs-keyword">instanceof</span> JReturnStmt)<br>                    || (succ <span class="hljs-keyword">instanceof</span> JReturnVoidStmt)) <span class="hljs-keyword">break</span>;<br>            succ = graph.getSuccsOf(succ).get(<span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initializeFlowDroid</span><span class="hljs-params">()</span></span>&#123;<br>        InfoflowAndroidConfiguration config = <span class="hljs-keyword">new</span> InfoflowAndroidConfiguration();<br>        config.setInspectSinks(<span class="hljs-keyword">false</span>);<br>        config.setInspectSources(<span class="hljs-keyword">false</span>);<br>        config.setCodeEliminationMode(InfoflowConfiguration.CodeEliminationMode.NoCodeElimination);<br>        config.getCallbackConfig().setCallbackAnalysisTimeout(<span class="hljs-number">120</span>);<br>        config.getAnalysisFileConfig().setAndroidPlatformDir(<span class="hljs-string">&quot;D:\\Android SDK\\platforms&quot;</span>);<br>        config.getAnalysisFileConfig().setTargetAPKFile(<span class="hljs-string">&quot;C:\\Users\\守城\\Desktop\\Step2\\Lab_4.apk&quot;</span>);<br>        SetupApplication setupApplication = <span class="hljs-keyword">new</span> SetupApplication(config);<br>        setupApplication.constructCallgraph();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initializeSoot</span><span class="hljs-params">()</span></span>&#123;<br>        G.reset();<br>        Options.v().set_prepend_classpath(<span class="hljs-keyword">true</span>);<br>        Options.v().set_allow_phantom_refs(<span class="hljs-keyword">true</span>);<br>        Options.v().set_src_prec(Options.src_prec_apk);<br>        Options.v().set_process_dir(Collections.singletonList(<span class="hljs-string">&quot;C:\\Users\\守城\\Desktop\\Step2\\Lab_4.apk&quot;</span>));<br>        Options.v().set_android_jars(<span class="hljs-string">&quot;D:\\Android SDK\\platforms&quot;</span>);<br>        Options.v().set_whole_program(<span class="hljs-keyword">true</span>);<br>        List&lt;String&gt; excludeList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        excludeList.add(<span class="hljs-string">&quot;java.*&quot;</span>);<br>        excludeList.add(<span class="hljs-string">&quot;javax.*&quot;</span>);<br>        excludeList.add(<span class="hljs-string">&quot;androidx.*&quot;</span>);<br>        Options.v().set_exclude(excludeList);<span class="hljs-comment">//排除不需要分析的类和方法</span><br>        Options.v().set_output_format(Options.output_format_jimple);<br>        Options.v().setPhaseOption(<span class="hljs-string">&quot;cg.spark&quot;</span>, <span class="hljs-string">&quot;on&quot;</span>);<br>        Scene.v().loadNecessaryClasses();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LiveAnalysis</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BackwardFlowAnalysis</span>&lt;<span class="hljs-title">Unit</span>, <span class="hljs-title">Set</span>&lt;<span class="hljs-title">String</span>&gt;&gt; </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LiveAnalysis</span><span class="hljs-params">(UnitGraph graph)</span> </span>&#123;<br>            <span class="hljs-keyword">super</span>(graph);<br>            doAnalysis();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> Set&lt;String&gt; <span class="hljs-title">newInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> Set&lt;String&gt; <span class="hljs-title">entryInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(Set&lt;String&gt; in1, Set&lt;String&gt; in2, Set&lt;String&gt; out)</span> </span>&#123;<br>            out.clear();<br>            out.addAll(in1);<br>            out.addAll(in2);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">copy</span><span class="hljs-params">(Set&lt;String&gt; source, Set&lt;String&gt; dest)</span> </span>&#123;<br>            dest.clear();<br>            dest.addAll(source);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flowThrough</span><span class="hljs-params">(Set&lt;String&gt; in, Unit unit, Set&lt;String&gt; out)</span> </span>&#123;<br>            out.clear();<br>            out.addAll(in);<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes()) &#123;<br>                Value value = box.getValue();<br>                <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Local) &#123;<br>                    out.remove(((Local) value).getName());<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getUseBoxes())&#123;<br>                Value value = box.getValue();<br>                <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Local)&#123;<br>                    out.add(((Local) value).getName());<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstantPropagation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ForwardFlowAnalysis</span>&lt;<span class="hljs-title">Unit</span>, <span class="hljs-title">Map</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Object</span>&gt;&gt; </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstantPropagation</span><span class="hljs-params">(UnitGraph graph)</span> </span>&#123;<br>            <span class="hljs-keyword">super</span>(graph);<br>            doAnalysis();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; <span class="hljs-title">newInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; <span class="hljs-title">entryInitialFlow</span><span class="hljs-params">()</span> </span>&#123;<br>            Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>            List&lt;Value&gt; valueList = ((UnitGraph)graph).getBody().getParameterRefs();<br>            <span class="hljs-keyword">for</span> (Value value : valueList)&#123;<br>                String className = ((RefType) value.getType()).getClassName();<br>                <span class="hljs-keyword">if</span> (className.equals(<span class="hljs-string">&quot;java.lang.Integer&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.String&quot;</span>)<br>                        || className.equals(<span class="hljs-string">&quot;java.lang.Boolean&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Byte&quot;</span>)<br>                        || className.equals(<span class="hljs-string">&quot;java.lang.Character&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Double&quot;</span>)<br>                        || className.equals(<span class="hljs-string">&quot;java.lang.Float&quot;</span>) || className.equals(<span class="hljs-string">&quot;java.lang.Long&quot;</span>)<br>                        || className.equals(<span class="hljs-string">&quot;java.lang.Short&quot;</span>))&#123;<br>                    map.put(value.toString(), value.toString().substring(<span class="hljs-number">0</span>, <span class="hljs-number">11</span>));<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> map;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(Map&lt;String, Object&gt; in1, Map&lt;String, Object&gt; in2, Map&lt;String, Object&gt; out)</span> </span>&#123;<br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry1 : in1.entrySet())&#123;<br>                String parameter1 = entry1.getKey();<br>                <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry2 : in2.entrySet())&#123;<br>                    String parameter2 = entry2.getKey();<br>                    <span class="hljs-keyword">if</span> (parameter1.equals(parameter2))&#123;<br>                        out.put(parameter1, <span class="hljs-string">&quot;Constant&quot;</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">copy</span><span class="hljs-params">(Map&lt;String, Object&gt; source, Map&lt;String, Object&gt; dest)</span> </span>&#123;<br>            dest.clear();<br>            dest.putAll(source);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flowThrough</span><span class="hljs-params">(Map&lt;String, Object&gt; in, Unit unit, Map&lt;String, Object&gt; out)</span> </span>&#123;<br>            out.clear();<br>            out.putAll(in);<br>            <span class="hljs-keyword">boolean</span> isConstant = <span class="hljs-keyword">false</span>;<br>            <span class="hljs-keyword">boolean</span> isConstantValue = <span class="hljs-keyword">true</span>;<br>            <span class="hljs-keyword">boolean</span> isParameter = <span class="hljs-keyword">false</span>;<br>            String para = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">for</span> (ValueBox box : unit.getUseBoxes())&#123;<br>                Value value = box.getValue();<br>                <span class="hljs-comment">// 判断 x = y - y 这种特殊情况</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> SubExpr &amp;&amp; ((JSubExpr) unit).getOp1Box().getValue() == ((JSubExpr) unit).getOp2Box().getValue())&#123;<br>                    isConstant = <span class="hljs-keyword">true</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (out.containsKey(value.toString()) &amp;&amp; ((String)out.get(value.toString())).equals(<span class="hljs-string">&quot;NAC&quot;</span>))&#123;<br>                    isConstant = <span class="hljs-keyword">false</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Constant || (out.containsKey(value.toString()) &amp;&amp; ((String)out.get(value.toString())).startsWith(<span class="hljs-string">&quot;@parameter&quot;</span>)))&#123;<br>                    isConstant = <span class="hljs-keyword">true</span>;<br>                    <span class="hljs-keyword">if</span> (out.containsKey(value.toString()) &amp;&amp; ((String)out.get(value.toString())).equals(<span class="hljs-string">&quot;Constant&quot;</span>)) isConstantValue = <span class="hljs-keyword">false</span>;<br>                    <span class="hljs-keyword">if</span> (out.containsKey(value.toString()) &amp;&amp; ((String)out.get(value.toString())).startsWith(<span class="hljs-string">&quot;@parameter&quot;</span>))&#123;<br>                        isParameter = <span class="hljs-keyword">true</span>;<br>                        para = ((String)out.get(value.toString())).substring(<span class="hljs-number">0</span>, <span class="hljs-number">11</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (isConstant &amp;&amp; isConstantValue &amp;&amp; !isParameter)&#123;<br>                <span class="hljs-keyword">int</span> constantValue = <span class="hljs-number">0</span>;<br>                <span class="hljs-comment">// 单个赋值语句</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> JAssignStmt)&#123;<br>                    Value op = ((JAssignStmt)unit).getRightOp();<br>                    <span class="hljs-keyword">if</span> (out.containsKey(op.toString()))&#123;<br>                        constantValue = (Integer)(out.get(op.toString()));<br>                    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op <span class="hljs-keyword">instanceof</span> Constant)&#123;<br>                        constantValue = ((IntConstant)op).value;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-comment">// 判断加法</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> AddExpr)&#123;<br>                    Value op1 = ((AddExpr) unit).getOp1();<br>                    Value op2 = ((AddExpr) unit).getOp2();<br>                    constantValue = ((IntConstant)op1).value + ((IntConstant)op2).value;<br>                &#125;<br>                <span class="hljs-comment">// 判断减法</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> SubExpr)&#123;<br>                    Value op1 = ((JSubExpr) unit).getOp1();<br>                    Value op2 = ((JSubExpr) unit).getOp2();<br>                    constantValue = ((IntConstant)op1).value - ((IntConstant)op2).value;<br>                &#125;<br>                <span class="hljs-comment">// 判断乘法</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> MulExpr)&#123;<br>                    Value op1 = ((MulExpr) unit).getOp1();<br>                    Value op2 = ((MulExpr) unit).getOp2();<br>                    constantValue = ((IntConstant)op1).value * ((IntConstant)op2).value;<br>                &#125;<br>                <span class="hljs-comment">// 判断除法</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> DivExpr)&#123;<br>                    Value op1 = ((DivExpr) unit).getOp1();<br>                    Value op2 = ((DivExpr) unit).getOp2();<br>                    constantValue = ((IntConstant)op1).value / ((IntConstant)op2).value;<br>                &#125;<br>                <span class="hljs-comment">// 判断取余</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> RemExpr)&#123;<br>                    Value op1 = ((RemExpr) unit).getOp1();<br>                    Value op2 = ((RemExpr) unit).getOp2();<br>                    constantValue = ((IntConstant)op1).value % ((IntConstant)op2).value;<br>                &#125;<br>                <span class="hljs-comment">// 判断与运算</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> AndExpr)&#123;<br>                    IntConstant op1 = (IntConstant) ((AndExpr) unit).getOp1();<br>                    IntConstant op2 = (IntConstant) ((AndExpr) unit).getOp2();<br>                    constantValue = op1.value &amp; op2.value;<br>                &#125;<br>                <span class="hljs-comment">// 判断或运算</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> OrExpr)&#123;<br>                    IntConstant op1 = (IntConstant) ((OrExpr) unit).getOp1();<br>                    IntConstant op2 = (IntConstant) ((OrExpr) unit).getOp2();<br>                    constantValue = op1.value | op2.value;<br>                &#125;<br>                <span class="hljs-comment">// 判断异或运算</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> XorExpr)&#123;<br>                    IntConstant op1 = (IntConstant) ((XorExpr) unit).getOp1();<br>                    IntConstant op2 = (IntConstant) ((XorExpr) unit).getOp2();<br>                    constantValue = op1.value ^ op2.value;<br>                &#125;<br>                <span class="hljs-comment">// 判断左移</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> ShlExpr)&#123;<br>                    IntConstant op1 = (IntConstant) ((ShlExpr) unit).getOp1();<br>                    IntConstant op2 = (IntConstant) ((ShlExpr) unit).getOp2();<br>                    constantValue = op1.value &lt;&lt; op2.value;<br>                &#125;<br>                <span class="hljs-comment">// 判断右移</span><br>                <span class="hljs-keyword">if</span> (unit <span class="hljs-keyword">instanceof</span> ShrExpr)&#123;<br>                    IntConstant op1 = (IntConstant) ((ShrExpr) unit).getOp1();<br>                    IntConstant op2 = (IntConstant) ((ShrExpr) unit).getOp2();<br>                    constantValue = op1.value &gt;&gt; op2.value;<br>                &#125;<br>                <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                    Value value = box.getValue();<br>                    out.put(value.toString(), constantValue);<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isConstant &amp;&amp; !isConstantValue)&#123;<br>                <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                    Value value = box.getValue();<br>                    out.put(value.toString(), <span class="hljs-string">&quot;Constant&quot;</span>);<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isConstant &amp;&amp; isParameter)&#123;<br>                <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                    Value value = box.getValue();<br>                    out.put(value.toString(), para);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">for</span> (ValueBox box : unit.getDefBoxes())&#123;<br>                    Value value = box.getValue();<br>                    out.put(value.toString(), <span class="hljs-string">&quot;NAC&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="FlowDroid"><a href="#FlowDroid" class="headerlink" title="FlowDroid"></a>FlowDroid</h3><h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000019977434">https://segmentfault.com/a/1190000019977434</a></p>
<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>FlowDroid(github<a href="https://link.zhihu.com/?target=https://github.com/secure-software-engineering/FlowDroid">链接</a>)是目前对 Android app 进行污点分析效果最好的工具之一，数据流算法是基于IFDS算法实现的。 污点分析的目的其实很简单，就是为了检查应用中是否存在从污点源到泄漏点的数据流。 但是它的优点在于它构建的数据流精度很高，可以对上下文、流、对象和字段敏感，从而使得分析结果非常精确。</p>
<p>FlowDroid的常规配置如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">InfoflowAndroidConfiguration config = <span class="hljs-keyword">new</span> InfoflowAndroidConfiguration();<br><span class="hljs-comment">//设置时限，避免陷入死循环</span><br>config.getCallbackConfig().setCallbackAnalysisTimeout(<span class="hljs-number">120</span>);<br><span class="hljs-comment">//设置sdk中的platform路径</span><br>config.getAnalysisFileConfig().setAndroidPlatformDir(androidPlatformsPath);<br><span class="hljs-comment">//设置需要分析的apk的文件路径</span><br>config.getAnalysisFileConfig().setTargetAPKFile(apkFilePath)<br>SetupApplication setupApplication = <span class="hljs-keyword">new</span> SetupApplication(config);<br><span class="hljs-comment">//构建CG</span><br>setupApplication.constructCallgraph();<br><br>InfoflowAndroidConfiguration config = <span class="hljs-keyword">new</span> InfoflowAndroidConfiguration();<br>config.getCallbackConfig().setCallbackAnalysisTimeout(<span class="hljs-number">120</span>);<br>config.getAnalysisFileConfig().setAndroidPlatformDir(androidPlatformsPath);<br>config.getAnalysisFileConfig().setTargetAPKFile(apkFilePath)<br>SetupApplication setupApplication = <span class="hljs-keyword">new</span> SetupApplication(config);<br>setupApplication.constructCallgraph();<br></code></pre></td></tr></table></figure>

<p>Soot中，CallGraph的算法选项主要包括：</p>
<ol>
<li>CHA(Call Hierarchy Analysis)：默认的静态分析算法，基于类的继承关系分析方法调用；</li>
<li>RTA(Rapid Type Analysis)：基于CHA的分析算法，会预先分析虚函数表，提高精度；</li>
<li>VTA(Virtual Call Target Analysis)：基于RTA的分析算法，会分析方法内部的虚函数调用，进一步提高精度；</li>
<li>Spark：另一种基于CHA的算法，相对于CHA，Spark的性能更高，但精度可能会降低。</li>
</ol>
<p>区别主要体现在精度和性能上，CHA是最基本的分析算法，精度较低，但相对而言，性能较高，适用于大型的代码库；而RTA和VTA在提高精度的同时，也增加了分析的时间成本，适用于小型的代码库或者需要更精确的分析场景；Spark在精度和性能上都相对于CHA有一定的提升，但精度仍然不及RTA和VTA。因此，在选择算法时需要根据具体的分析场景来决定使用哪种算法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Spark</span><br>Options.v().setPhaseOption(<span class="hljs-string">&quot;cg.spark&quot;</span>, <span class="hljs-string">&quot;on&quot;</span>);<br><span class="hljs-comment">//CHA</span><br>Options.v().setPhaseOption(<span class="hljs-string">&quot;cg.cha&quot;</span>, <span class="hljs-string">&quot;on&quot;</span>);<br><span class="hljs-comment">//RTA</span><br>Options.v().setPhaseOption(<span class="hljs-string">&quot;cg.spark&quot;</span>, <span class="hljs-string">&quot;on&quot;</span>);<br>Options.v().setPhaseOption(<span class="hljs-string">&quot;cg.spark&quot;</span>, <span class="hljs-string">&quot;rta:true&quot;</span>);<br><span class="hljs-comment">//On-fly-CG：在构建CG时，在遍历字节码的同时进行CG的构建，遇到一个方法调用时就添加一个对应的边。</span><br>Options.v().setPhaseOption(<span class="hljs-string">&quot;cg.spark&quot;</span>, <span class="hljs-string">&quot;on-fly-cg:false&quot;</span>);<br><span class="hljs-comment">//VTA</span><br>Options.v().setPhaseOption(<span class="hljs-string">&quot;cg.spark&quot;</span>, <span class="hljs-string">&quot;on&quot;</span>);<br>Options.v().setPhaseOption(<span class="hljs-string">&quot;cg.spark&quot;</span>, <span class="hljs-string">&quot;vta:true&quot;</span>);<br></code></pre></td></tr></table></figure>



<h4 id="污点分析"><a href="#污点分析" class="headerlink" title="污点分析"></a>污点分析</h4><p>做污点分析的配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//sourceSinkFilePath是source点与sink点的声明文件</span><br>config.getAnalysisFileConfig().setSourceSinkFile(sourceSinkFilePath);<br><span class="hljs-comment">// apk中的dex文件有对方法数量的限制导致实际app中往往是多dex，不作设置将仅分析classes.dex</span><br>config.setMergeDexFiles(<span class="hljs-keyword">true</span>);<br><span class="hljs-comment">//设置AccessPath的path长度限制，默认为5，设置-1表示不作限制</span><br>config.getAccessPathConfiguration().setAccessPathLength(-<span class="hljs-number">1</span>);<br><span class="hljs-comment">//设置Abstractio的path长度限制，设置-1表示不作限制</span><br>config.getAccessPathConfiguration().setMaxAbstractionPathLength(-<span class="hljs-number">1</span>);<br>SetupApplication setupApplication = <span class="hljs-keyword">new</span> SetupApplication(config);<br><span class="hljs-comment">//设置Callback的声明文件</span><br>SetupApplication.setCallbackFile(<span class="hljs-string">&quot;AndroidCallbacks.txt&quot;</span>);<br>setupApplication.calculateSourcesSinksEntrypoints(<span class="hljs-string">&quot;SourcesAndSinks.txt&quot;</span>);<br>SetupApplication.runInfoflow();<br></code></pre></td></tr></table></figure>

<ul>
<li>AccessPath 是程序中指向内存位置的一条路径。例如一个Java对象的字段可以被表示为对象的引用AccessPath的一部分。AccessPath的一些常见例子包括用于追踪对象属性的“this.field”、“array[index]”等等。</li>
<li>Abstraction 是指在程序分析中，为了简化程序，将某些复杂的细节隐藏在某些更抽象的形式下。例如，可以将整个对象视为单个抽象值，而不考虑它的具体结构和属性。在这种情况下，抽象表示仅仅是一个值或一些值的集合，它们代表了一些具体的值的集合。这种简化可以加速程序分析的速度，但会牺牲一些准确性。</li>
</ul>
<h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><ul>
<li>进行FlowDroid的配置，需要加载SourcesAndSinks.txt、AndroidCallbacks.txt文件</li>
<li>对Soot进行配置初始化，需要加载CG配置</li>
<li>构建一个虚拟的main方法，添加到入口点（entrypoint）</li>
<li>遍历entrypoint收集回调函数</li>
<li>有可能还需要进入xml文件中做进一步的回调函数的分析</li>
<li>将SourceAndSink.txt文件中包含的source、sink点，封装到sourceSinkManager中</li>
<li>生成CG图，并以此生成ICFG图</li>
<li>接下来基于CG、ICFG，计算存在的source、sink</li>
<li>确认source到sink间是否存在连通的数据路径，如果存在则认为是一个风险点</li>
<li>最终输出结果</li>
</ul>
<h3 id="jimple"><a href="#jimple" class="headerlink" title="jimple"></a>jimple</h3><p>Jimple 是 soot 中最主要的中间表示，是一种三地址码（三地址码 Three-Address Code 也可简写为3AC，<strong>要求：指令右侧至多有一个操作符。</strong>）只需要大约15种不同的指令，例如：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-built_in">t2</span> = a + <span class="hljs-keyword">b </span>+ <span class="hljs-number">3</span><br>三地址码则表示为<br><span class="hljs-built_in">t1</span> = a + <span class="hljs-keyword">b</span><br><span class="hljs-keyword"></span><span class="hljs-built_in">t2</span> = <span class="hljs-built_in">t1</span> + <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<p>使用 r0，r1，r2….表示类型对象；i0，i1，i2…..表示基本数据类型变量；带有 $ 表示临时变量，如上面的 t2 的含义；@parameter 表示函数参数。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">specialinvoke 	用于调用构造方法、父类方法、私有方法<br>virtualinvoke 	用于调用普通的成员方法<br>staticinvoke  	用于调用静态方法<br><span class="hljs-built_in">int</span>erfaceinvoke 相对于virtualinvoke不做优化，需要额外检查接口的实现<br></code></pre></td></tr></table></figure>

<p>其他部分与 smali 挺相像的，并且是很好理解的，直接看是十分容易明白的。直接看下面的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Loop</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++)&#123;<br>            x = x+<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><br>jimple：<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Loop</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">java</span>.<span class="hljs-title">lang</span>.<span class="hljs-title">Object</span></span><br><span class="hljs-class"></span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> &lt;init&gt;()<br>    &#123;<br>        Loop r0;<br><br>        r0 := <span class="hljs-meta">@this</span>: Loop;<br><br>        specialinvoke r0.&lt;java.lang.Object: <span class="hljs-keyword">void</span> &lt;init&gt;()&gt;();<br><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(java.lang.String[])</span></span><br><span class="hljs-function">    </span>&#123;<br>        java.lang.String[] r0;<br>        <span class="hljs-keyword">int</span> i1;<br><br>        r0 := <span class="hljs-meta">@parameter0</span>: java.lang.String[];<br><br>        i1 = <span class="hljs-number">0</span>;<br><br>     label1:<br>        <span class="hljs-keyword">if</span> i1 &gt;= <span class="hljs-number">10</span> goto label2;<br><br>        i1 = i1 + <span class="hljs-number">1</span>;<br><br>        goto label1;<br><br>     label2:<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>在 jimple 代码中，开头是一个叫 Loop 的类继承了 java.lang.Object 类(默认的所有类的父类），然后是一个初始化的过程，生成默认的构造函数，默认会调用父类的构造函数(即 java.lang.Object )，接下来就是 main 函数，在源代码里 main 函数有一个 String[] args 的参数，这在 jimple 代码中就对应了一个声明的参数 r0，源代码中 for 循环里面的 i 在 jimple 代码中用 i1 指代，label1 里面的内容就是 for 循环的条件内容，只要不满足循环条件，用一个 goto 语句跳转到 label2。这里出现了一个有意思的现象，那就是源代码中 x 值的变化在 jimple 中被“优化”掉了，这是因为 x 是不活跃变量，所以会被优化。</p>
<h4 id="do-while循环"><a href="#do-while循环" class="headerlink" title="do-while循环"></a>do-while循环</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoWhile</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">10</span>];<br>        <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            i = i+<span class="hljs-number">1</span>;<br>        &#125;<span class="hljs-keyword">while</span> (arr[i]&lt;<span class="hljs-number">10</span>);<br>    &#125;<br>&#125;<br><br>jimple：<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoWhile</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">java</span>.<span class="hljs-title">lang</span>.<span class="hljs-title">Object</span></span><br><span class="hljs-class"></span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> &lt;init&gt;()<br>    &#123;<br>        DoWhile r0;<br><br>        r0 := <span class="hljs-meta">@this</span>: DoWhile;<br><br>        specialinvoke r0.&lt;java.lang.Object: <span class="hljs-keyword">void</span> &lt;init&gt;()&gt;();<br><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(java.lang.String[])</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">int</span>[] r0;<br>        <span class="hljs-keyword">int</span> $i0, i1;<br>        java.lang.String[] r1;<br><br>        r1 := <span class="hljs-meta">@parameter0</span>: java.lang.String[];<br><br>        r0 = newarray (<span class="hljs-keyword">int</span>)[<span class="hljs-number">10</span>];<br><br>        i1 = <span class="hljs-number">0</span>;<br><br>     label1:<br>        i1 = i1 + <span class="hljs-number">1</span>;<br><br>        $i0 = r0[i1];<br><br>        <span class="hljs-keyword">if</span> $i0 &lt; <span class="hljs-number">10</span> goto label1;<br><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里是给数据对象 arr 用 r0 来代替，并对它进行了初始化，接下来还是用 label 表示程序的位置，将每一次循环的条件都能表示出来。可以注意到：Do-While 循环是先进入循环执行对应的语句，再通过 if 语句进行循环的跳转。</p>
<h4 id="Switch语句"><a href="#Switch语句" class="headerlink" title="Switch语句"></a>Switch语句</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SwitchExample</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> input = Integer.parseInt(args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">switch</span> (input) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                System.out.println(<span class="hljs-string">&quot;Case 1&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                System.out.println(<span class="hljs-string">&quot;Case 2&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                System.out.println(<span class="hljs-string">&quot;Default case&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><br>Jimple:<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SwitchExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">java</span>.<span class="hljs-title">lang</span>.<span class="hljs-title">Object</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> &lt;init&gt;() &#123;<br>        SwitchExample r0;<br>        <br>        r0 := <span class="hljs-meta">@this</span>: SwitchExample;<br>        specialinvoke r0.&lt;java.lang.Object: <span class="hljs-keyword">void</span> &lt;init&gt;()&gt;();<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(java.lang.String[])</span> </span>&#123;<br>        java.lang.String[] r0;<br>        <span class="hljs-keyword">int</span> i1, $i0;<br>        java.lang.String r2;<br>        java.io.PrintStream $r1;<br>        <br>        r0 := <span class="hljs-meta">@parameter0</span>: java.lang.String[];<br>        r2 = r0[<span class="hljs-number">0</span>];<br>        staticinvoke &lt;java.lang.Integer: <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">parseInt</span><span class="hljs-params">(java.lang.String)</span>&gt;<span class="hljs-params">(r2)</span></span>;<br>        i1 = $i0;<br>        <br>        lookupswitch(i1) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: goto label1;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: goto label2;<br>            <span class="hljs-keyword">default</span>: goto label3;<br>        &#125;<br>        <br>    label1:<br>        $r1 = &lt;java.lang.System: java.io.PrintStream out&gt;;<br>        $r1.println(<span class="hljs-string">&quot;Case 1&quot;</span>);<br>        goto label4;<br>        <br>    label2:<br>        $r1 = &lt;java.lang.System: java.io.PrintStream out&gt;;<br>        $r1.println(<span class="hljs-string">&quot;Case 2&quot;</span>);<br>        goto label4;<br>        <br>    label3:<br>        $r1 = &lt;java.lang.System: java.io.PrintStream out&gt;;<br>        $r1.println(<span class="hljs-string">&quot;Default case&quot;</span>);<br>        <br>    label4:<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在此Jimple代码示例中，switch 语句被转换为lookupswitch（或者tableswitch）指令，后面跟随着各个case标签的跳转指令。每个case标签下面的代码表示对应case的操作。在这个例子中，每个case都会调用System.out.println()来输出相应的字符串。</p>
<ul>
<li>lookupswitch是根据一个键值来匹配分支，这些键值是离散的，不一定是连续的整数。</li>
<li>tableswitch则是基于一个偏移量来进行分支匹配，分支的键值必须是连续的整数。</li>
</ul>
<h4 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodCall</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> a = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">int</span> b = <span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">int</span> c = foo(a,b);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x, <span class="hljs-keyword">int</span> y)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> x + y;<br>    &#125;<br>&#125;<br><br>jimple：<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodCall</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">java</span>.<span class="hljs-title">lang</span>.<span class="hljs-title">Object</span></span><br><span class="hljs-class"></span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> &lt;init&gt;()<br>    &#123;<br>        MethodCall r0;<br><br>        r0 := <span class="hljs-meta">@this</span>: MethodCall;<br><br>        specialinvoke r0.&lt;java.lang.Object: <span class="hljs-keyword">void</span> &lt;init&gt;()&gt;();<br><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(java.lang.String[])</span></span><br><span class="hljs-function">    </span>&#123;<br>        java.lang.String[] r0;<br><br>        r0 := <span class="hljs-meta">@parameter0</span>: java.lang.String[];<br><br>        staticinvoke &lt;MethodCall: <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span>)</span>&gt;<span class="hljs-params">(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)</span></span>;<br><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">int</span> i0, i1, $i2;<br><br>        i0 := <span class="hljs-meta">@parameter0</span>: <span class="hljs-keyword">int</span>;<br><br>        i1 := <span class="hljs-meta">@parameter1</span>: <span class="hljs-keyword">int</span>;<br><br>        $i2 = i0 + i1;<br><br>        <span class="hljs-keyword">return</span> $i2;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到我们定义的方法 foo 在源代码和 jimple 源码中差不多，很好理解，就是用了一个中间变量来取得 i0 和 i1 的和，再将这个中间变量 $i2 返回。在 main 函数中使用 staticinvoke 表示静态方法的调用。</p>

      </section>
      <section class="extra">
        
          <ul class="copyright">
  
    <li><strong>本文作者：</strong>ShouCheng</li>
    <li><strong>本文链接：</strong><a href="http://shoucheng3.github.io/2023/03/24/2023-03-24-soot-And-jimple/index.html" title="http:&#x2F;&#x2F;shoucheng3.github.io&#x2F;2023&#x2F;03&#x2F;24&#x2F;2023-03-24-soot-And-jimple&#x2F;index.html">http:&#x2F;&#x2F;shoucheng3.github.io&#x2F;2023&#x2F;03&#x2F;24&#x2F;2023-03-24-soot-And-jimple&#x2F;index.html</a></li>
    <li><strong>版权声明：</strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" title="BY-NC-SA" target="_blank" rel="noopener">BY-NC-SA</a> 许可协议，转载请注明出处！</li>
  
</ul>
        
        
        
        
  <nav class="nav">
    <a></a>
    <a href="/2023/03/17/2023-03-17-smali%E8%AF%AD%E6%B3%95/">smali语法<i class="iconfont iconright"></i></a>
  </nav>

      </section>
      
        <section class="comments">
  
    <div class="btn" id="comments-btn">查看评论</div>
  
  
</section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">文章目录：</h3>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Soot"><span class="toc-text">Soot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FlowDroid"><span class="toc-text">FlowDroid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jimple"><span class="toc-text">jimple</span></a></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  

<footer class="footer">
  <div class="footer-social"><a 
        href="tencent://message/?Menu=yes&uin=1145020611 "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#12B7F5'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconQQ "></i>
      </a><a 
        href="javascript:; "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#09BB07'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconwechat-fill "></i>
      </a><a 
        href="https://www.instagram.com/izhaoo/ "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#DA2E76'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconinstagram "></i>
      </a><a 
        href="https://shoucheng3.github.io "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#9f7be1'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  icongithub-fill "></i>
      </a><a 
        href="mailto:1145020611@qq.com "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color=#FF3B00" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconmail"></i>
      </a></div>
  
    <div class="footer-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme - <a target="_blank" href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p></div>
  
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
    <div class="fab fab-daovoice">
      <i class="iconfont iconcomment"></i>
    </div>
  
  
    <a href="https://support.qq.com/product/325288# app_id" target="_blank">
      <div class="fab fab-tencent-chao">
        <i class="iconfont iconcomment"></i>
      </div>
    </a>
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
  
    
<script src="/js/color-mode.js"></script>

  
  
    <div class="search">
  <div class="search-container">
    <div class="search-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <div class="search-input-wrapper">
      <i class="search-input-icon iconfont iconsearch"></i>
      <input class="search-input" type="search" id="search-input" placeholder="Search..." autofocus autocomplete="off"
        autocorrect="off" autocapitalize="off">
    </div>
    <div class="search-output" id="search-output"></div>
  </div>
</div>
  
</body>

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>



  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>






  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>




<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>





  

<script>
  (function (i, s, o, g, r, a, m) {
    i["DaoVoiceObject"] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o), m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    a.charset = "utf-8";
    m.parentNode.insertBefore(a, m)
  })(window, document, "script", "https://widget.daovoice.io/widget/0f81ff2f.js", "daovoice")
  daovoice('init', {
    app_id: "3abd194f# app_id"
  }, {
    launcher: {
      disableLauncherIcon: true,
    },
  });
  daovoice('update');
</script>



  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>













</html>